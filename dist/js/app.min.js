"use strict";var app=angular.module("app",["angular-loading-bar","ngAnimate","ui.router","toastr","ui.bootstrap","schemaForm","angularBootstrapNavTree","ngCookies"]).run(function(){console.log("app started...")});angular.module("app").service("authService",["$log","$injector","$q","$http","$cookies",function(t,e,n,o,r){function i(t){var e=n.defer(),i=e.promise;return o.post("login",t).then(function(t){t.data.status?(r.put("token",t.data.token),e.resolve(!0)):e.reject(t.data.msg)}),i}function a(){var t=n.defer(),e=t.promise;return o.post("logout",{}).then(function(e){e.data.status?(r.remove("token"),t.resolve()):t.reject()}),e}function c(){var t=r.get("token");return!!t}var s=this;s.login=i,s.logout=a,s.checkLogin=c}]),angular.module("app").config(["$httpProvider","toastrConfig","$locationProvider",function(t,e,n){t.interceptors.push("authorInterceptor"),n.html5Mode({enabled:!0,requireBase:!0}),angular.extend(e,{timeOut:2e3})}]),angular.module("app").controller("ListController",["docService","authService","logService","$location","$stateParams","$scope","toastr","$state","$uibModal",function(t,e,n,o,r,i,a,c,s){function d(){n.getLog().then(function(t){l.logs=t},function(t){a.warning(t)})}function u(){t.getAllDoc().then(function(e){l.docs=e,l.docs.forEach(function(e){t.getDocument(e._id).then(function(n){e.children=t.getApiList(n.model||[])})})},function(t){a.warning(t||"文档获取失败")})}var l=this;l.docs=[],i.isLogin=e.checkLogin(),l.logout=function(){e.logout().then(function(t){window.location.href="/"},function(t){a.warning(t)})},l.deleteDoc=function(){var e=r.id;if(!e)return void a.warning("请选中要删除的文档");var n=s.open({animation:!0,templateUrl:"confirm.html",controller:"delDocumentCtl",keyboard:!1,backdrop:"static"});n.result.then(function(){t.delDocument(e).then(function(t){u(),d(),c.go("home"),a.success(t)},function(t){a.warning(t)})},function(){console.log("delete document rejected")})},l.editDoc=function(){var t=r.id;t||a.warning("请选中要编辑的文档");var e=s.open({animation:!0,templateUrl:"page/editDoc.html",keyboard:!1,controller:"editDocInfoCtrl",backdrop:"static"});e.result.then(function(t){location.reload()},function(t){})},u(),d()}]).controller("MainController",["$scope","$stateParams","toastr","$state","$uibModal","apiService",function(t,e,n,o,r,i){function a(){c.apiId&&i.getApi(c.apiId,c.docId).then(function(t){c.api=t.model[0],c.documentInfo=t.documentInfo[0]},function(t){n.warning(t)})}var c=this;c.docId=e.id,c.apiId=e.aid,c.delApi=function(){var t=r.open({animation:!0,templateUrl:"confirm.html",controller:"delDocumentCtl",keyboard:!1,backdrop:"static"});t.result.then(function(){i.deleteApi(c.apiId).then(function(){n.success("删除成功"),o.transitionTo("home.doc",{id:c.docId,aid:""},{reload:"home.doc"})},function(t){n.warning(t)})},function(){console.log("delete api rejected")})},a()}]).controller("NewDocumentController",["$scope","toastr","$state","docService",function(t,e,n,o){var r=this;r.newDocs={type:0},r.newDocument=function(){o.newDocument(r.newDocs).then(function(t){e.success(t),n.transitionTo("home",{},{reload:!0})},function(t){e.warning(t)})}}]).controller("AddApiController",["$scope","toastr","$uibModal","$stateParams","apiService","$state",function(t,e,n,o,r,i){function a(t){return t%1===0}var c=this;c.newApi={params:[],res:[],callbackParams:[],method:"POST"},c.addSchema=formConfig[0].schema,c.addForm=formConfig[0].form,c.addModel=c.newApi,c.addApi=function(t){c.newApi.doc_id=o.id,r.addApi({body:c.newApi}).then(function(t){e.success(t.msg),i.transitionTo("home.doc",{id:o.id},{reload:!0})},function(t){e.warning(t)})},c.showJSONinput=function(){var t=n.open({animation:!0,templateUrl:"page/jsonInput.html",controller:"JsonInputController",keyboard:!1,backdrop:"static"});t.result.then(function(t){try{var n=JSON.parse(t)}catch(o){e.warning("非法的JSON字符串!")}for(var r in n){var i={key:r,require:"是",type:typeof n[r]};"number"==typeof n[r]&&(a(n[r])?i.type="int":i.type="float"),"object"==typeof n[r]&&(i.revalue=JSON.stringify(n[r])),c.newApi.res.push(i)}})}}]).controller("delDocumentCtl",["$uibModalInstance","$scope",function(t,e){e.ok=function(){t.close(!0)},e.cancel=function(){t.dismiss()}}]).controller("editApiCtrl",["$scope","apiService","toastr","$uibModal","$stateParams","$state",function(t,e,n,o,r,i){function a(){e.getApi(d,u).then(function(t){s.api=t.model[0],s.documentInfo=t.model.documentInfo,s.editSchema=formConfig[0].schema,s.editForm=formConfig[0].form,s.editModel=s.api},function(t){n.warning(t)})}function c(t){return t%1===0}var s=this,d=r.aid,u=r.id;s.showJSONinput=function(){var t=o.open({animation:!0,templateUrl:"page/jsonInput.html",controller:"JsonInputController",keyboard:!1,backdrop:"static"});t.result.then(function(t){try{var e=JSON.parse(t)}catch(o){n.warning("非法的JSON字符串!")}for(var r in e){var i={key:r,require:"是",type:typeof e[r]};"number"==typeof e[r]&&(c(e[r])?i.type="int":i.type="float"),"object"==typeof e[r]&&(i.revalue=JSON.stringify(e[r])),s.api.res.push(i)}})},s.submitAdd=function(t){delete s.api._id,e.editApi({id:r.aid,api:s.api}).then(function(t){n.success(t.msg),i.transitionTo("home.doc",{id:r.id,aid:r.aid},{reload:"home.doc"})},function(t){n.warning(t)})},a()}]).controller("ErrorController",["$stateParams","docService","$scope",function(t,e,n){var o=this;o.docId=t.id,o.apiId=t.aid,o.errors=[],e.getDocument(t.id).then(function(t){o.errors=t.documentInfo[0].errorCodeLst||[]})}]).controller("EditErrController",["$stateParams","docService","toastr","$scope",function(t,e,n,o){function r(){e.getDocument(t.id).then(function(t){i.errors=t.documentInfo[0].errorCodeLst||[]})}var i=this;i.addErrs=function(){e.editError({id:t.id,body:i.errors}).then(function(t){n.success(t),history.go(-1)},function(t){n.warning(t)})},i.addErr=function(){i.errors.push({})},i.delErr=function(t){i.errors.splice(t,1)},r()}]).controller("LoginController",["$scope","toastr","$state","authService",function(t,e,n,o){t.login=function(r){r.$valid?o.login(t.user).then(function(t){n.go("home",{},{reload:"home"})},function(t){e.warning(t)}):e.warning("请输入完整登录信息")}}]).controller("editDocInfoCtrl",["$scope","$uibModalInstance","docService","toastr","$stateParams",function(t,e,n,o,r){n.getDocument(r.id).then(function(e){t.documentInfo=e.documentInfo[0],t.add_model=t.documentInfo},function(t){o.warning(t)}),t.add_schema={type:"object",properties:{label:{type:"string",title:"name"},type:{type:"string",title:"docType"},description:{type:"string",title:"description"}},required:["label","type"]},t.add_form=["label",{key:"type",type:"select",titleMap:{0:"api",1:"sdk"}},{key:"description",type:"textarea"},{type:"submit",title:"save"}],t.hideModal=function(){e.dismiss()},t.submitAdd=function(i){t.$broadcast("schemaFormValidate"),delete t.add_model._id,i.$valid&&i.$dirty?n.editDocment({id:r.id,info:t.add_model}).then(function(n){o.success(n),e.close(t.add_model)},function(t){o.warning(t),e.dismiss()}):o.warning("请把表单填完整后在提交")}}]).controller("JsonInputController",["$scope","$uibModalInstance",function(t,e){t.ok=function(){e.close(t.jsonInput)},t.cancel=function(){e.dismiss()}}]),angular.module("app").directive("onErrReady",["$timeout",function(t){return{restrict:"A",link:function(t){t.addErr=function(){var e={name:"",res:"",description:""};t.errors.push(e)},t.delErr=function(e){t.errors.splice(e,1)}}}}]),angular.module("app").filter("docType",function(){return function(t){switch(t){case"0":return"api";case"1":return"sdk"}}});var formConfig=[{schema:{type:"object",properties:{label:{type:"string",title:"请求名称",description:"接口的名称"},api:{type:"string",title:"请求路径",description:"接口路径"},method:{type:"string",title:"请求模式","enum":["POST","GET"]},params:{type:"array",title:"请求头(header)",items:{type:"object",properties:{apiName:{type:"string",title:"参数名称"},type:{type:"string",title:"类型"},require:{type:"string",title:"是否必填","default":"是"},apiValue:{type:"string",title:"说明"}}}},res:{type:"array",title:"请求参数",items:{type:"object",properties:{key:{type:"string",title:"参数名称"},type:{type:"string",title:"类型"},require:{type:"string",title:"是否必填","default":"是"},revalue:{type:"string",title:"说明"}}}},demo:{type:"string",title:"JSON返回示例"},description:{type:"string",title:"接口说明"}}},form:["label","api","method",{key:"res",add:"添加",items:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-6",items:["res[].key"]},{type:"section",htmlClass:"col-xs-6",items:["res[].type"]},{type:"section",htmlClass:"col-xs-6",items:["res[].require"]},{type:"section",htmlClass:"col-xs-6",items:["res[].revalue"]}]}]},{key:"demo",type:"textarea"},{key:"description",type:"textarea"},{type:"submit",title:"保存"}]}];angular.module("app").config(["$stateProvider","$urlRouterProvider",function(t,e){t.state("home",{url:"/",templateUrl:function(){return"page/list.html?"+Math.random()}}).state("home.doc",{url:":id/:aid",views:{apiContent:{templateUrl:function(){return"page/document.html?"+Math.random()},controller:"MainController"}}}).state("home.edit",{url:":id/:aid/edit",views:{apiContent:{templateUrl:function(){return"page/form.html?"+Math.random()},controller:"editApiCtrl"}}}).state("home.new",{url:"new",views:{"main-container":{templateUrl:function(){return"page/newDocument.html?"+Math.random()}}}}).state("home.login",{url:"login",views:{"main-container":{templateUrl:function(){return"page/login.html?"+Math.random()},controller:"LoginController"}}}).state("home.newApi",{url:":id/:apiId/newApi",views:{apiContent:{templateUrl:function(){return"page/newApi.html?"+Math.random()}}}}).state("home.error",{url:":id/:aid/errCode",views:{apiContent:{templateUrl:function(){return"page/errorCode.html?"+Math.random()}}}}).state("home.editErr",{url:":id/:aid/edit/err",views:{apiContent:{templateUrl:function(){return"page/errorForm.html?"+Math.random()}}}});e.otherwise("/")}]),angular.module("app").factory("authorInterceptor",["$log","$injector","$q","$rootScope","$location","$cookies",function(t,e,n,o,r,i){var a={request:function(t){if(t.data){var e=i.get("token");t.headers.authorization="Bearer "+e||""}return t},response:function(t){return t||n.when(t)},responseError:function(t){return 401===t.status&&(alert("请先登录!"),e.get("$state").go("home.login")),t}};return a}]).factory("logService",["$q","$http",function(t,e){return{getLog:function(){var n=t.defer(),o=n.promise,r={};return e.post("getLog",r).then(function(t){t.data.status?n.resolve(t.data.model||[]):n.reject(t.data.msg)}),o}}}]).factory("docService",["$q","$http",function(t,e){function n(n){var o=t.defer(),r=o.promise;return e.post("newDocument",n).then(function(t){t.data.status?o.resolve(t.data.msg):o.reject(t.data.msg||"创建失败")}),r}function o(n){var o=t.defer(),r=o.promise;return e.post("editDocs",n).then(function(t){t.data.status?o.resolve(t.data.msg):o.reject(t.data.msg||"创建失败")}),r}function r(){var n=t.defer(),o=n.promise;return e.post("getAllDocs",{}).then(function(t){n.resolve(t.data.model||[])}),o}function i(n){var o=t.defer(),r=o.promise;return e.post("getDocument",{id:n}).then(function(t){o.resolve(t.data)}),r}function a(t){for(var e=[],n=0;n<t.length;n++){var o=t[n].doc_id,r=t[n]._id,i=t[n].label;e.push({label:i,doc_id:o,api_id:r})}return e}function c(n){var o=t.defer(),r=o.promise;return e.post("delDocument",{doc_id:n}).then(function(t){t.data.status?o.resolve(t.data.msg):o.reject(t.data.msg||"删除失败")}),r}function s(n){var o=t.defer(),r=o.promise;return e.post("editErrorCode",n).then(function(t){t.data.status?o.resolve(t.data.msg):o.reject("编辑失败")}),r}var d={getAllDoc:r,getDocument:i,getApiList:a,delDocument:c,newDocument:n,editDocument:o,editError:s};return d}]).factory("apiService",["$q","$http",function(t,e){function n(n,o){var r=t.defer(),i=r.promise;return e.post("selectApi",{id:n,doc_id:o}).then(function(t){t.data.status?r.resolve(t.data):r.reject(t.data.msg||"接口获取失败")},function(t){r.reject(t.data.msg||"接口获取失败")}),i}function o(n,o){var r=t.defer(),i=r.promise;return e.post("delApi",{id:n}).then(function(t){t.data.status?r.resolve(t.data):r.reject(t.data.msg||"接口删除失败")},function(t){r.reject(t.data.msg||"接口删除失败")}),i}function r(n){var o=t.defer(),r=o.promise;return e.post("addApi",n).then(function(t){t.data.status?o.resolve(t.data):o.reject(t.data.msg||"接口添加失败")},function(t){o.reject(t.data.msg||"接口添加失败")}),r}function i(n){var o=t.defer(),r=o.promise;return e.post("editApi",n).then(function(t){t.data.status?o.resolve(t.data):o.reject(t.data.msg||"接口添加失败")},function(t){o.reject(t.data.msg||"接口添加失败")}),r}var a={getApi:n,deleteApi:o,addApi:r,editApi:i};return a}]);